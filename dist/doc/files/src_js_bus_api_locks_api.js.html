<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\js\bus\api\locks\api.js - ozpIwc</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="ozpIwc" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: launch-in-webtop</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ozpIwc.alert.html">ozpIwc.alert</a></li>
                                <li><a href="../classes/ozpIwc.api.html">ozpIwc.api</a></li>
                                <li><a href="../classes/ozpIwc.api.base.Api.html">ozpIwc.api.base.Api</a></li>
                                <li><a href="../classes/ozpIwc.api.base.Node.html">ozpIwc.api.base.Node</a></li>
                                <li><a href="../classes/ozpIwc.api.data.Api.html">ozpIwc.api.data.Api</a></li>
                                <li><a href="../classes/ozpIwc.api.data.node.Node.html">ozpIwc.api.data.node.Node</a></li>
                                <li><a href="../classes/ozpIwc.api.data.node.Nodev2.html">ozpIwc.api.data.node.Nodev2</a></li>
                                <li><a href="../classes/ozpIwc.api.Endpoint.html">ozpIwc.api.Endpoint</a></li>
                                <li><a href="../classes/ozpIwc.api.EndpointRegistry.html">ozpIwc.api.EndpointRegistry</a></li>
                                <li><a href="../classes/ozpIwc.api.error.BadActionError.html">ozpIwc.api.error.BadActionError</a></li>
                                <li><a href="../classes/ozpIwc.api.error.BadContentError.html">ozpIwc.api.error.BadContentError</a></li>
                                <li><a href="../classes/ozpIwc.api.error.BadRequestError.html">ozpIwc.api.error.BadRequestError</a></li>
                                <li><a href="../classes/ozpIwc.api.error.BadResourceError.html">ozpIwc.api.error.BadResourceError</a></li>
                                <li><a href="../classes/ozpIwc.api.error.BadStateError.html">ozpIwc.api.error.BadStateError</a></li>
                                <li><a href="../classes/ozpIwc.api.error.BaseError.html">ozpIwc.api.error.BaseError</a></li>
                                <li><a href="../classes/ozpIwc.api.error.NoActionError.html">ozpIwc.api.error.NoActionError</a></li>
                                <li><a href="../classes/ozpIwc.api.error.NoMatchError.html">ozpIwc.api.error.NoMatchError</a></li>
                                <li><a href="../classes/ozpIwc.api.error.NoPermissionError.html">ozpIwc.api.error.NoPermissionError</a></li>
                                <li><a href="../classes/ozpIwc.api.error.NoResourceError.html">ozpIwc.api.error.NoResourceError</a></li>
                                <li><a href="../classes/ozpIwc.api.filter.base.html">ozpIwc.api.filter.base</a></li>
                                <li><a href="../classes/ozpIwc.api.filter.Function.html">ozpIwc.api.filter.Function</a></li>
                                <li><a href="../classes/ozpIwc.api.filter.standard.html">ozpIwc.api.filter.standard</a></li>
                                <li><a href="../classes/ozpIwc.api.intents.Api.html">ozpIwc.api.intents.Api</a></li>
                                <li><a href="../classes/ozpIwc.api.intents.FSM.html">ozpIwc.api.intents.FSM</a></li>
                                <li><a href="../classes/ozpIwc.api.Lifespan.Bound.html">ozpIwc.api.Lifespan.Bound</a></li>
                                <li><a href="../classes/ozpIwc.api.Lifespan.Ephemeral.html">ozpIwc.api.Lifespan.Ephemeral</a></li>
                                <li><a href="../classes/ozpIwc.api.Lifespan.Persistent.html">ozpIwc.api.Lifespan.Persistent</a></li>
                                <li><a href="../classes/ozpIwc.api.locks.Api.html">ozpIwc.api.locks.Api</a></li>
                                <li><a href="../classes/ozpIwc.api.locks.Node.html">ozpIwc.api.locks.Node</a></li>
                                <li><a href="../classes/ozpIwc.api.names.Api.html">ozpIwc.api.names.Api</a></li>
                                <li><a href="../classes/ozpIwc.api.names.Node.html">ozpIwc.api.names.Node</a></li>
                                <li><a href="../classes/ozpIwc.api.system.Api.html">ozpIwc.api.system.Api</a></li>
                                <li><a href="../classes/ozpIwc.api.system.node.ApplicationNode.html">ozpIwc.api.system.node.ApplicationNode</a></li>
                                <li><a href="../classes/ozpIwc.api.system.node.ApplicationNodeV2.html">ozpIwc.api.system.node.ApplicationNodeV2</a></li>
                                <li><a href="../classes/ozpIwc.api.system.node.SystemNode.html">ozpIwc.api.system.node.SystemNode</a></li>
                                <li><a href="../classes/ozpIwc.api.system.node.UserNode.html">ozpIwc.api.system.node.UserNode</a></li>
                                <li><a href="../classes/ozpIwc.api.system.node.UserNodeV2.html">ozpIwc.api.system.node.UserNodeV2</a></li>
                                <li><a href="../classes/ozpIwc.apiMap.html">ozpIwc.apiMap</a></li>
                                <li><a href="../classes/ozpIwc.Client.html">ozpIwc.Client</a></li>
                                <li><a href="../classes/ozpIwc.Debugger.html">ozpIwc.Debugger</a></li>
                                <li><a href="../classes/ozpIwc.Lifespan.html">ozpIwc.Lifespan</a></li>
                                <li><a href="../classes/ozpIwc.log.html">ozpIwc.log</a></li>
                                <li><a href="../classes/ozpIwc.metric.Registry.html">ozpIwc.metric.Registry</a></li>
                                <li><a href="../classes/ozpIwc.metric.stats.BinaryHeap.html">ozpIwc.metric.stats.BinaryHeap</a></li>
                                <li><a href="../classes/ozpIwc.metric.stats.ExponentiallyDecayingSample.html">ozpIwc.metric.stats.ExponentiallyDecayingSample</a></li>
                                <li><a href="../classes/ozpIwc.metric.stats.Sample.html">ozpIwc.metric.stats.Sample</a></li>
                                <li><a href="../classes/ozpIwc.metric.stats.UniformSample.html">ozpIwc.metric.stats.UniformSample</a></li>
                                <li><a href="../classes/ozpIwc.metric.types.BaseMetric.html">ozpIwc.metric.types.BaseMetric</a></li>
                                <li><a href="../classes/ozpIwc.metric.types.Counter.html">ozpIwc.metric.types.Counter</a></li>
                                <li><a href="../classes/ozpIwc.metric.types.Gauge.html">ozpIwc.metric.types.Gauge</a></li>
                                <li><a href="../classes/ozpIwc.metric.types.Histogram.html">ozpIwc.metric.types.Histogram</a></li>
                                <li><a href="../classes/ozpIwc.metric.types.Meter.html">ozpIwc.metric.types.Meter</a></li>
                                <li><a href="../classes/ozpIwc.network.KeyBroadcastLocalStorageLink.html">ozpIwc.network.KeyBroadcastLocalStorageLink</a></li>
                                <li><a href="../classes/ozpIwc.network.Peer.html">ozpIwc.network.Peer</a></li>
                                <li><a href="../classes/ozpIwc.packet.Fragment.html">ozpIwc.packet.Fragment</a></li>
                                <li><a href="../classes/ozpIwc.packet.FragmentStore.html">ozpIwc.packet.FragmentStore</a></li>
                                <li><a href="../classes/ozpIwc.packet.Network.html">ozpIwc.packet.Network</a></li>
                                <li><a href="../classes/ozpIwc.packet.Transport.html">ozpIwc.packet.Transport</a></li>
                                <li><a href="../classes/ozpIwc.policyAuth.elements.SecurityAttribute.html">ozpIwc.policyAuth.elements.SecurityAttribute</a></li>
                                <li><a href="../classes/ozpIwc.policyAuth.points.PDP.html">ozpIwc.policyAuth.points.PDP</a></li>
                                <li><a href="../classes/ozpIwc.policyAuth.points.PIP.html">ozpIwc.policyAuth.points.PIP</a></li>
                                <li><a href="../classes/ozpIwc.policyAuth.points.PRP.html">ozpIwc.policyAuth.points.PRP</a></li>
                                <li><a href="../classes/ozpIwc.policyAuth.points.utils.html">ozpIwc.policyAuth.points.utils</a></li>
                                <li><a href="../classes/ozpIwc.policyAuth.policies.html">ozpIwc.policyAuth.policies</a></li>
                                <li><a href="../classes/ozpIwc.policyAuth.PolicyCombining.html">ozpIwc.policyAuth.PolicyCombining</a></li>
                                <li><a href="../classes/ozpIwc.Timer.html">ozpIwc.Timer</a></li>
                                <li><a href="../classes/ozpIwc.transport.consensus.Base.html">ozpIwc.transport.consensus.Base</a></li>
                                <li><a href="../classes/ozpIwc.transport.consensus.Bully.html">ozpIwc.transport.consensus.Bully</a></li>
                                <li><a href="../classes/ozpIwc.transport.listener.SharedWorker.html">ozpIwc.transport.listener.SharedWorker</a></li>
                                <li><a href="../classes/ozpIwc.transport.PacketContext.html">ozpIwc.transport.PacketContext</a></li>
                                <li><a href="../classes/ozpIwc.transport.participant.Base.html">ozpIwc.transport.participant.Base</a></li>
                                <li><a href="../classes/ozpIwc.transport.participant.Client.html">ozpIwc.transport.participant.Client</a></li>
                                <li><a href="../classes/ozpIwc.transport.participant.Debugger.html">ozpIwc.transport.participant.Debugger</a></li>
                                <li><a href="../classes/ozpIwc.transport.participant.Internal.html">ozpIwc.transport.participant.Internal</a></li>
                                <li><a href="../classes/ozpIwc.transport.participant.Multicast.html">ozpIwc.transport.participant.Multicast</a></li>
                                <li><a href="../classes/ozpIwc.transport.participant.MutexClient.html">ozpIwc.transport.participant.MutexClient</a></li>
                                <li><a href="../classes/ozpIwc.transport.participant.PostMessage.html">ozpIwc.transport.participant.PostMessage</a></li>
                                <li><a href="../classes/ozpIwc.transport.participant.RouterWatchdog.html">ozpIwc.transport.participant.RouterWatchdog</a></li>
                                <li><a href="../classes/ozpIwc.transport.participant.SharedWorker.html">ozpIwc.transport.participant.SharedWorker</a></li>
                                <li><a href="../classes/ozpIwc.transport.Router.html">ozpIwc.transport.Router</a></li>
                                <li><a href="../classes/ozpIwc.util.html">ozpIwc.util</a></li>
                                <li><a href="../classes/ozpIwc.util.AjaxPersistenceQueue.html">ozpIwc.util.AjaxPersistenceQueue</a></li>
                                <li><a href="../classes/ozpIwc.util.ApiPromiseMixin.html">ozpIwc.util.ApiPromiseMixin</a></li>
                                <li><a href="../classes/ozpIwc.util.AsyncAction.html">ozpIwc.util.AsyncAction</a></li>
                                <li><a href="../classes/ozpIwc.util.CancelableEvent.html">ozpIwc.util.CancelableEvent</a></li>
                                <li><a href="../classes/ozpIwc.util.Event.html">ozpIwc.util.Event</a></li>
                                <li><a href="../classes/ozpIwc.util.mutex.html">ozpIwc.util.mutex</a></li>
                                <li><a href="../classes/ozpIwc.util.object.html">ozpIwc.util.object</a></li>
                                <li><a href="../classes/ozpIwc.util.PacketRouter.html">ozpIwc.util.PacketRouter</a></li>
                                <li><a href="../classes/ozpIwc.util.Reference.html">ozpIwc.util.Reference</a></li>
                                <li><a href="../classes/ozpIwc.wiring.html">ozpIwc.wiring</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/ozpIwc.html">ozpIwc</a></li>
                                <li><a href="../modules/ozpIwc.api.html">ozpIwc.api</a></li>
                                <li><a href="../modules/ozpIwc.api.base.html">ozpIwc.api.base</a></li>
                                <li><a href="../modules/ozpIwc.api.data.html">ozpIwc.api.data</a></li>
                                <li><a href="../modules/ozpIwc.api.data.node.html">ozpIwc.api.data.node</a></li>
                                <li><a href="../modules/ozpIwc.api.error.html">ozpIwc.api.error</a></li>
                                <li><a href="../modules/ozpIwc.api.filter.html">ozpIwc.api.filter</a></li>
                                <li><a href="../modules/ozpIwc.api.intents.html">ozpIwc.api.intents</a></li>
                                <li><a href="../modules/ozpIwc.api.intents.node.html">ozpIwc.api.intents.node</a></li>
                                <li><a href="../modules/ozpIwc.api.locks.html">ozpIwc.api.locks</a></li>
                                <li><a href="../modules/ozpIwc.api.names.html">ozpIwc.api.names</a></li>
                                <li><a href="../modules/ozpIwc.api.system.html">ozpIwc.api.system</a></li>
                                <li><a href="../modules/ozpIwc.api.system.node.html">ozpIwc.api.system.node</a></li>
                                <li><a href="../modules/ozpIwc.metric.html">ozpIwc.metric</a></li>
                                <li><a href="../modules/ozpIwc.metric.stats.html">ozpIwc.metric.stats</a></li>
                                <li><a href="../modules/ozpIwc.metric.types.html">ozpIwc.metric.types</a></li>
                                <li><a href="../modules/ozpIwc.network.html">ozpIwc.network</a></li>
                                <li><a href="../modules/ozpIwc.packet.html">ozpIwc.packet</a></li>
                                <li><a href="../modules/ozpIwc.policyAuth.html">ozpIwc.policyAuth</a></li>
                                <li><a href="../modules/ozpIwc.policyAuth.elements.html">ozpIwc.policyAuth.elements</a></li>
                                <li><a href="../modules/ozpIwc.policyAuth.points.html">ozpIwc.policyAuth.points</a></li>
                                <li><a href="../modules/ozpIwc.transport.html">ozpIwc.transport</a></li>
                                <li><a href="../modules/ozpIwc.transport.consensus.html">ozpIwc.transport.consensus</a></li>
                                <li><a href="../modules/ozpIwc.transport.listener.html">ozpIwc.transport.listener</a></li>
                                <li><a href="../modules/ozpIwc.transport.participant.html">ozpIwc.transport.participant</a></li>
                                <li><a href="../modules/ozpIwc.util.html">ozpIwc.util</a></li>
                                <li><a href="../modules/ozpIwc.worker.html">ozpIwc.worker</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src\js\bus\api\locks\api.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var ozpIwc = ozpIwc || {};
ozpIwc.api = ozpIwc.api || {};
ozpIwc.api.locks = ozpIwc.api.locks || {};

/**
 * @module ozpIwc.api
 * @submodule ozpIwc.api.locks
 */

ozpIwc.api.locks.Api = (function (api, log, ozpConfig, transport, util) {

    /**
     * The Locks Api. Treats each node as an individual mutex, creating a queue to access/own the resource.
     * Subclasses the {{#crossLink &quot;ozpIwc.api.base.Api&quot;}}{{/crossLink}}. Utilizes the
     * {{#crossLink &quot;ozpIwc.api.locks.Node&quot;}}{{/crossLink}} which subclasses the
     * {{#crossLink &quot;ozpIwc.CommonApiValue&quot;}}{{/crossLink}}.
     *
     * @class Api
     * @namespace ozpIwc.api.locks
     * @extends ozpIwc.api.base.Api
     * @uses ozpIwc.util.PacketRouter, ozpIwc.util.Event
     * @constructor
     *
     * @type {Function}
     */
    var Api = util.extend(api.base.Api, function (config) {
        if (!config.router) {
            throw Error(&quot;API must be configured with a router.&quot;);
        }
        if (!config.authorization) {
            throw Error(&quot;API must be configured with an authorization module.&quot;);
        }
        this.name = &quot;locks.api&quot;;
        this.coordinationAddress = &quot;coord.&quot; + this.name;
        this.events = new util.Event();
        this.events.mixinOnOff(this);
        this.router = config.router;
        this.endpoints = [];
        this.data = {};
        this.watchers = {};
        this.collectors = [];
        this.changeList = {};
        this.authorization = config.authorization;

        //Start queueing and queue until either:
        // (1) state comes in a victor message or
        // (2) become leader. whichever is first
        this.enableRequestQueue();
        this.enableSendQueue();

        consensusConfiguration(this, config.consensusMember);
        participantConfiguration(this);

        this.logPrefix = &quot;[&quot; + this.name + &quot;/&quot; + this.participant.address + &quot;] &quot;;

        //This is poor form, but the apiBase behavior for locks should let everyone write.
        this.leaderState = &quot;loading&quot;;
        this.transitionToLeader();

        var self = this;
        util.addEventListener(&quot;beforeunload&quot;, function () {
            self.shutdown();
        });
    });
    util.PacketRouter.mixin(Api);

//--------------------------------------------------
//          Private Methods
//--------------------------------------------------
    /**
     * The Locks Api uses the Bully Consensus module to determine leadership.
     *
     * @method consensusConfiguration
     * @private
     * @static
     * @param {ozpIwc.api.locks.Api} api
     * @param {Object} [consensusMember]
     */
    var consensusConfiguration = function (api, consensusMember) {
        api.consensusMember = consensusMember || new transport.consensus.Bully({
                &#x27;name&#x27;: api.name,
                &#x27;authorization&#x27;: api.authorization,
                &#x27;router&#x27;: api.router,
                &#x27;gatherLogs&#x27;: function () {
                    return api.createDeathScream();
                }
            });
        api.consensusMember.on(&quot;receivedLogs&quot;, handleLogs, api);
        api.consensusMember.on(&quot;changedState&quot;, handleConsensusState, api);

        //If we&#x27;re using a shared worker we won&#x27;t have to elect a leader, its always the same one.
        if (util.runningInWorker) {
            api.consensusMember.participant.connect().then(function () {
                api.consensusMember.onBecomeCoordinator();
            });
        }
    };

    /**
     * For Api call handling, the Locks Api uses a clientParticipant.
     *
     * @method participantConfiguration
     * @private
     * @static
     * @param {api.locks.Api} api
     */
    var participantConfiguration = function (api) {
        api.participant = new transport.participant.Client({
            &#x27;internal&#x27;: true,
            &#x27;authorization&#x27;: api.authorization,
            &#x27;router&#x27;: api.router,
            &#x27;name&#x27;: api.name
        });
        api.participant.on(&quot;receive&quot;, function (packetContext) {
            api.receivePacketContext(packetContext);
        });

        api.participant.on(&quot;addressDisconnects&quot;, api.unlockAll, api);
        api.router.registerMulticast(api.participant, [api.name]);
        if (api.consensusMember.state === &quot;coordinator&quot;) {
            api.deliverRequestQueue();
        }
    };

    /**
     * If the Locks Api object has not been initialized, it will initialize with the data passed in to the handleLogs
     * function.
     *
     * @method handleLogs
     * @private
     * @param {Object}data
     */
    var handleLogs = function (data) {
        if (this.initialized) {
            return;
        }
        this.initialized = true;
        var logTimestamp = data.timestamp;
        this.initializeData(data);
        this.deliverRequestQueue(logTimestamp);
    };

    /**
     * When the Consensus Module changes state, the Locks Api behaves differently. It&#x27;s participant will only send
     * outbound messages if it is the &quot;Coordinator&quot;.
     *
     * @method handleConsensusState
     * @private
     * @param {String} state
     */
    var handleConsensusState = function (state) {
        log.debug(&quot;[&quot; + this.participant.address + &quot;] State: &quot;, state);
        switch (state) {
            case &quot;coordinator&quot;:
                this.deliverRequestQueue();
                this.deliverSendQueue();
                break;
            default:
                this.participant.sendingBlocked = true;
                this.flushSendQueue();
                break;
        }
    };

//--------------------------------------------------
//          Public Methods
//--------------------------------------------------
    /**
     * Transitions the Lock Api&#x27;s leader state to leader if its state currently is &quot;loading&quot;. Broadcasts leader ready
     * event.
     * @method transitionToLeader
     */
    Api.prototype.transitionToLeader = function () {
        if (this.leaderState !== &quot;loading&quot;) {
            log.error(this.logPrefix + &quot;transition to leader called in an invalid state:&quot;, this.leaderState);
            return;
        }
        log.debug(this.logPrefix + &quot;transitioning to leader&quot;);
        this.leaderState = &quot;leader&quot;;
        this.broadcastLeaderReady();
    };

    /**
     * Unlocks All queued locks for the given address in the Locks Api.
     *
     * @TODO: Right now cycles through Every node, keep a map of addresses to nodes to unlock.
     *
     * @method unlockAll
     * @param {String} address
     */
    Api.prototype.unlockAll = function (address) {
        var self = this;
        util.object.eachEntry(this.data, function (k, v) {
            self.updateLock(v, v.unlock({
                src: address
            }));
        });
    };

    /**
     * Iterates over all node&#x27;s and cleans out any rouge locks queue&#x27;d for no-longer/non-existent addresses.
     *
     * @method cleanup
     */
    Api.prototype.cleanup = function () {
        var addrMap = {};
        util.object.eachEntry(this.data, function (k, v) {
            var queue = v.entity.queue || [];
            queue.forEach(function (entry) {
                addrMap[entry.src] = true;
            });
        });

        var self = this;
        this.participant.names().bulkGet(&quot;/address&quot;).then(function (reply) {
            reply.entity.forEach(function (node) {
                if (node.entity.time &amp;&amp; node.entity.time + ozpConfig.heartBeatFrequency &gt; util.now()) {
                    addrMap[node.entity.address] = false;
                }
            });
        }).then(function () {
            util.object.eachEntry(addrMap, function (k, v) {
                if (v) {
                    self.unlockAll(k);
                }
            });
        });
    };

    /**
     * Override the default node type to be a Locks Api Value.
     *
     * @override
     * @method createNodeObject
     * @param {type} config
     * @return {ozpIwc.api.data.node}
     */
    Api.prototype.createNodeObject = function (config) {
        return new api.locks.Node(config);
    };


    /**
     * Shuts down the api, issuing a deathscream and releasing the lock, if possible.
     *
     * @method shutdown
     * @return
     */
    Api.prototype.shutdown = function () {
        this.participant.send({
            dst: &quot;locks.api&quot;,
            resource: &quot;/mutex/&quot; + this.name,
            action: &quot;unlock&quot;
        });
    };

//====================================================================
// Default Route
//====================================================================
    Api.useDefaultRoute = function (actions, resource) {
        resource = resource || &quot;{resource:.*}&quot;;
        actions = util.ensureArray(actions);
        var self = this;
        actions.forEach(function (a) {
            var filterFunc = api.filter.standard.forAction(a);
            self.declareRoute({
                    action: a,
                    resource: resource,
                    filters: (filterFunc ? filterFunc() : [])
                }, api.base.Api.defaultHandler[a]
            );
        });
    };

    Api.useDefaultRoute([&quot;bulkGet&quot;, &quot;list&quot;, &quot;get&quot;, &quot;watch&quot;, &quot;unwatch&quot;]);
//====================================================================
// Bulk Send
//====================================================================
    Api.declareRoute({
        action: [&quot;bulkSend&quot;],
        resource: &quot;{resource:.*}&quot;,
        filters: []
    }, function (packet, context, pathParams) {
        var messages = packet.entity || [];
        var self = this;

        messages.forEach(function (message) {
            var packetContext = new transport.PacketContext({
                &#x27;packet&#x27;: message.packet,
                &#x27;router&#x27;: self.router,
                &#x27;srcParticipant&#x27;: message.packet.src,
                &#x27;dstParticipant&#x27;: self.address
            });
            self.receiveRequestPacket(packetContext);
        });
        return {response: &quot;ok&quot;};
    });

//====================================================================
// Lock
//====================================================================
    Api.declareRoute({
        action: &quot;lock&quot;,
        resource: &quot;/mutex/{name}&quot;,
        filters: api.filter.standard.setFilters(api.locks.Node)
    }, function (packet, context, pathParams) {
        if (context.node) {
            this.updateLock(context.node, context.node.lock({
                src: packet.src,
                msgId: packet.msgId
            }));
        }
    });

//====================================================================
// Unlock
//====================================================================
    Api.declareRoute({
        action: &quot;unlock&quot;,
        resource: &quot;/mutex/{name}&quot;,
        filters: api.filter.standard.setFilters(api.locks.Node)
    }, function (packet, context, pathParams) {
        packet.entity = packet.entity || {};
        log.debug(&quot;[locks.api&quot; + context.node.resource + &quot;][UNLOCK]: &quot;, packet.src);
        if (context.node) {
            this.updateLock(context.node, context.node.unlock({
                src: packet.entity.src || packet.src,
                msgId: packet.entity.msgId || packet.msgId,
                entity: packet.entity.state || context.node.entity.state
            }));
        }
    });


//====================================================================
// Lock/Unlock Utility
//====================================================================
    /**
     * Notifies the owner of the node&#x27;s lock/unlock.
     *
     * @method updateLock
     * @param {ozpIwc.ApiValue} node
     * @param {Object} newOwner
     */
    Api.prototype.updateLock = function (node, newOwner) {
        if (newOwner) {
            log.debug(&quot;[locks.api&quot; + node.resource + &quot;][NEW LEADER]&quot;, newOwner);
            var pkt = {
                &#x27;dst&#x27;: newOwner.src,
                &#x27;src&#x27;: this.participant.name,
                &#x27;replyTo&#x27;: newOwner.msgId,
                &#x27;response&#x27;: &#x27;ok&#x27;,
                &#x27;resource&#x27;: node.resource,
                &#x27;entity&#x27;: node.entity.state
            };

            if (this.isSendQueueing) {
                this.sendQueue.push(pkt);
            } else {
                this.participant.send(pkt);
            }
        }
    };

    return Api;
}(ozpIwc.api, ozpIwc.log, ozpIwc.config, ozpIwc.transport, ozpIwc.util));

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
