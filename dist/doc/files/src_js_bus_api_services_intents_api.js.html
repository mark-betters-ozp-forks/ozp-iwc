<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\js\bus\api\services\intents\api.js - ozpIwc</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="ozpIwc" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: launch-in-webtop</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ozpIwc.alert.html">ozpIwc.alert</a></li>
                                <li><a href="../classes/ozpIwc.api.html">ozpIwc.api</a></li>
                                <li><a href="../classes/ozpIwc.api.base.Api.html">ozpIwc.api.base.Api</a></li>
                                <li><a href="../classes/ozpIwc.api.base.Node.html">ozpIwc.api.base.Node</a></li>
                                <li><a href="../classes/ozpIwc.api.data.Api.html">ozpIwc.api.data.Api</a></li>
                                <li><a href="../classes/ozpIwc.api.data.node.Node.html">ozpIwc.api.data.node.Node</a></li>
                                <li><a href="../classes/ozpIwc.api.data.node.Nodev2.html">ozpIwc.api.data.node.Nodev2</a></li>
                                <li><a href="../classes/ozpIwc.api.Endpoint.html">ozpIwc.api.Endpoint</a></li>
                                <li><a href="../classes/ozpIwc.api.EndpointRegistry.html">ozpIwc.api.EndpointRegistry</a></li>
                                <li><a href="../classes/ozpIwc.api.error.BadActionError.html">ozpIwc.api.error.BadActionError</a></li>
                                <li><a href="../classes/ozpIwc.api.error.BadContentError.html">ozpIwc.api.error.BadContentError</a></li>
                                <li><a href="../classes/ozpIwc.api.error.BadRequestError.html">ozpIwc.api.error.BadRequestError</a></li>
                                <li><a href="../classes/ozpIwc.api.error.BadResourceError.html">ozpIwc.api.error.BadResourceError</a></li>
                                <li><a href="../classes/ozpIwc.api.error.BadStateError.html">ozpIwc.api.error.BadStateError</a></li>
                                <li><a href="../classes/ozpIwc.api.error.BaseError.html">ozpIwc.api.error.BaseError</a></li>
                                <li><a href="../classes/ozpIwc.api.error.NoActionError.html">ozpIwc.api.error.NoActionError</a></li>
                                <li><a href="../classes/ozpIwc.api.error.NoMatchError.html">ozpIwc.api.error.NoMatchError</a></li>
                                <li><a href="../classes/ozpIwc.api.error.NoPermissionError.html">ozpIwc.api.error.NoPermissionError</a></li>
                                <li><a href="../classes/ozpIwc.api.error.NoResourceError.html">ozpIwc.api.error.NoResourceError</a></li>
                                <li><a href="../classes/ozpIwc.api.filter.base.html">ozpIwc.api.filter.base</a></li>
                                <li><a href="../classes/ozpIwc.api.filter.Function.html">ozpIwc.api.filter.Function</a></li>
                                <li><a href="../classes/ozpIwc.api.filter.standard.html">ozpIwc.api.filter.standard</a></li>
                                <li><a href="../classes/ozpIwc.api.intents.Api.html">ozpIwc.api.intents.Api</a></li>
                                <li><a href="../classes/ozpIwc.api.intents.FSM.html">ozpIwc.api.intents.FSM</a></li>
                                <li><a href="../classes/ozpIwc.api.Lifespan.Bound.html">ozpIwc.api.Lifespan.Bound</a></li>
                                <li><a href="../classes/ozpIwc.api.Lifespan.Ephemeral.html">ozpIwc.api.Lifespan.Ephemeral</a></li>
                                <li><a href="../classes/ozpIwc.api.Lifespan.Persistent.html">ozpIwc.api.Lifespan.Persistent</a></li>
                                <li><a href="../classes/ozpIwc.api.locks.Api.html">ozpIwc.api.locks.Api</a></li>
                                <li><a href="../classes/ozpIwc.api.locks.Node.html">ozpIwc.api.locks.Node</a></li>
                                <li><a href="../classes/ozpIwc.api.names.Api.html">ozpIwc.api.names.Api</a></li>
                                <li><a href="../classes/ozpIwc.api.names.Node.html">ozpIwc.api.names.Node</a></li>
                                <li><a href="../classes/ozpIwc.api.system.Api.html">ozpIwc.api.system.Api</a></li>
                                <li><a href="../classes/ozpIwc.api.system.node.ApplicationNode.html">ozpIwc.api.system.node.ApplicationNode</a></li>
                                <li><a href="../classes/ozpIwc.api.system.node.ApplicationNodeV2.html">ozpIwc.api.system.node.ApplicationNodeV2</a></li>
                                <li><a href="../classes/ozpIwc.api.system.node.SystemNode.html">ozpIwc.api.system.node.SystemNode</a></li>
                                <li><a href="../classes/ozpIwc.api.system.node.UserNode.html">ozpIwc.api.system.node.UserNode</a></li>
                                <li><a href="../classes/ozpIwc.api.system.node.UserNodeV2.html">ozpIwc.api.system.node.UserNodeV2</a></li>
                                <li><a href="../classes/ozpIwc.apiMap.html">ozpIwc.apiMap</a></li>
                                <li><a href="../classes/ozpIwc.Client.html">ozpIwc.Client</a></li>
                                <li><a href="../classes/ozpIwc.Debugger.html">ozpIwc.Debugger</a></li>
                                <li><a href="../classes/ozpIwc.Lifespan.html">ozpIwc.Lifespan</a></li>
                                <li><a href="../classes/ozpIwc.log.html">ozpIwc.log</a></li>
                                <li><a href="../classes/ozpIwc.metric.Registry.html">ozpIwc.metric.Registry</a></li>
                                <li><a href="../classes/ozpIwc.metric.stats.BinaryHeap.html">ozpIwc.metric.stats.BinaryHeap</a></li>
                                <li><a href="../classes/ozpIwc.metric.stats.ExponentiallyDecayingSample.html">ozpIwc.metric.stats.ExponentiallyDecayingSample</a></li>
                                <li><a href="../classes/ozpIwc.metric.stats.Sample.html">ozpIwc.metric.stats.Sample</a></li>
                                <li><a href="../classes/ozpIwc.metric.stats.UniformSample.html">ozpIwc.metric.stats.UniformSample</a></li>
                                <li><a href="../classes/ozpIwc.metric.types.BaseMetric.html">ozpIwc.metric.types.BaseMetric</a></li>
                                <li><a href="../classes/ozpIwc.metric.types.Counter.html">ozpIwc.metric.types.Counter</a></li>
                                <li><a href="../classes/ozpIwc.metric.types.Gauge.html">ozpIwc.metric.types.Gauge</a></li>
                                <li><a href="../classes/ozpIwc.metric.types.Histogram.html">ozpIwc.metric.types.Histogram</a></li>
                                <li><a href="../classes/ozpIwc.metric.types.Meter.html">ozpIwc.metric.types.Meter</a></li>
                                <li><a href="../classes/ozpIwc.network.KeyBroadcastLocalStorageLink.html">ozpIwc.network.KeyBroadcastLocalStorageLink</a></li>
                                <li><a href="../classes/ozpIwc.network.Peer.html">ozpIwc.network.Peer</a></li>
                                <li><a href="../classes/ozpIwc.packet.Fragment.html">ozpIwc.packet.Fragment</a></li>
                                <li><a href="../classes/ozpIwc.packet.FragmentStore.html">ozpIwc.packet.FragmentStore</a></li>
                                <li><a href="../classes/ozpIwc.packet.Network.html">ozpIwc.packet.Network</a></li>
                                <li><a href="../classes/ozpIwc.packet.Transport.html">ozpIwc.packet.Transport</a></li>
                                <li><a href="../classes/ozpIwc.policyAuth.elements.SecurityAttribute.html">ozpIwc.policyAuth.elements.SecurityAttribute</a></li>
                                <li><a href="../classes/ozpIwc.policyAuth.points.PDP.html">ozpIwc.policyAuth.points.PDP</a></li>
                                <li><a href="../classes/ozpIwc.policyAuth.points.PIP.html">ozpIwc.policyAuth.points.PIP</a></li>
                                <li><a href="../classes/ozpIwc.policyAuth.points.PRP.html">ozpIwc.policyAuth.points.PRP</a></li>
                                <li><a href="../classes/ozpIwc.policyAuth.points.utils.html">ozpIwc.policyAuth.points.utils</a></li>
                                <li><a href="../classes/ozpIwc.policyAuth.policies.html">ozpIwc.policyAuth.policies</a></li>
                                <li><a href="../classes/ozpIwc.policyAuth.PolicyCombining.html">ozpIwc.policyAuth.PolicyCombining</a></li>
                                <li><a href="../classes/ozpIwc.Timer.html">ozpIwc.Timer</a></li>
                                <li><a href="../classes/ozpIwc.transport.consensus.Base.html">ozpIwc.transport.consensus.Base</a></li>
                                <li><a href="../classes/ozpIwc.transport.consensus.Bully.html">ozpIwc.transport.consensus.Bully</a></li>
                                <li><a href="../classes/ozpIwc.transport.listener.SharedWorker.html">ozpIwc.transport.listener.SharedWorker</a></li>
                                <li><a href="../classes/ozpIwc.transport.PacketContext.html">ozpIwc.transport.PacketContext</a></li>
                                <li><a href="../classes/ozpIwc.transport.participant.Base.html">ozpIwc.transport.participant.Base</a></li>
                                <li><a href="../classes/ozpIwc.transport.participant.Client.html">ozpIwc.transport.participant.Client</a></li>
                                <li><a href="../classes/ozpIwc.transport.participant.Debugger.html">ozpIwc.transport.participant.Debugger</a></li>
                                <li><a href="../classes/ozpIwc.transport.participant.Internal.html">ozpIwc.transport.participant.Internal</a></li>
                                <li><a href="../classes/ozpIwc.transport.participant.Multicast.html">ozpIwc.transport.participant.Multicast</a></li>
                                <li><a href="../classes/ozpIwc.transport.participant.MutexClient.html">ozpIwc.transport.participant.MutexClient</a></li>
                                <li><a href="../classes/ozpIwc.transport.participant.PostMessage.html">ozpIwc.transport.participant.PostMessage</a></li>
                                <li><a href="../classes/ozpIwc.transport.participant.RouterWatchdog.html">ozpIwc.transport.participant.RouterWatchdog</a></li>
                                <li><a href="../classes/ozpIwc.transport.participant.SharedWorker.html">ozpIwc.transport.participant.SharedWorker</a></li>
                                <li><a href="../classes/ozpIwc.transport.Router.html">ozpIwc.transport.Router</a></li>
                                <li><a href="../classes/ozpIwc.util.html">ozpIwc.util</a></li>
                                <li><a href="../classes/ozpIwc.util.AjaxPersistenceQueue.html">ozpIwc.util.AjaxPersistenceQueue</a></li>
                                <li><a href="../classes/ozpIwc.util.ApiPromiseMixin.html">ozpIwc.util.ApiPromiseMixin</a></li>
                                <li><a href="../classes/ozpIwc.util.AsyncAction.html">ozpIwc.util.AsyncAction</a></li>
                                <li><a href="../classes/ozpIwc.util.CancelableEvent.html">ozpIwc.util.CancelableEvent</a></li>
                                <li><a href="../classes/ozpIwc.util.Event.html">ozpIwc.util.Event</a></li>
                                <li><a href="../classes/ozpIwc.util.mutex.html">ozpIwc.util.mutex</a></li>
                                <li><a href="../classes/ozpIwc.util.object.html">ozpIwc.util.object</a></li>
                                <li><a href="../classes/ozpIwc.util.PacketRouter.html">ozpIwc.util.PacketRouter</a></li>
                                <li><a href="../classes/ozpIwc.util.Reference.html">ozpIwc.util.Reference</a></li>
                                <li><a href="../classes/ozpIwc.wiring.html">ozpIwc.wiring</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/ozpIwc.html">ozpIwc</a></li>
                                <li><a href="../modules/ozpIwc.api.html">ozpIwc.api</a></li>
                                <li><a href="../modules/ozpIwc.api.base.html">ozpIwc.api.base</a></li>
                                <li><a href="../modules/ozpIwc.api.data.html">ozpIwc.api.data</a></li>
                                <li><a href="../modules/ozpIwc.api.data.node.html">ozpIwc.api.data.node</a></li>
                                <li><a href="../modules/ozpIwc.api.error.html">ozpIwc.api.error</a></li>
                                <li><a href="../modules/ozpIwc.api.filter.html">ozpIwc.api.filter</a></li>
                                <li><a href="../modules/ozpIwc.api.intents.html">ozpIwc.api.intents</a></li>
                                <li><a href="../modules/ozpIwc.api.intents.node.html">ozpIwc.api.intents.node</a></li>
                                <li><a href="../modules/ozpIwc.api.locks.html">ozpIwc.api.locks</a></li>
                                <li><a href="../modules/ozpIwc.api.names.html">ozpIwc.api.names</a></li>
                                <li><a href="../modules/ozpIwc.api.system.html">ozpIwc.api.system</a></li>
                                <li><a href="../modules/ozpIwc.api.system.node.html">ozpIwc.api.system.node</a></li>
                                <li><a href="../modules/ozpIwc.metric.html">ozpIwc.metric</a></li>
                                <li><a href="../modules/ozpIwc.metric.stats.html">ozpIwc.metric.stats</a></li>
                                <li><a href="../modules/ozpIwc.metric.types.html">ozpIwc.metric.types</a></li>
                                <li><a href="../modules/ozpIwc.network.html">ozpIwc.network</a></li>
                                <li><a href="../modules/ozpIwc.packet.html">ozpIwc.packet</a></li>
                                <li><a href="../modules/ozpIwc.policyAuth.html">ozpIwc.policyAuth</a></li>
                                <li><a href="../modules/ozpIwc.policyAuth.elements.html">ozpIwc.policyAuth.elements</a></li>
                                <li><a href="../modules/ozpIwc.policyAuth.points.html">ozpIwc.policyAuth.points</a></li>
                                <li><a href="../modules/ozpIwc.transport.html">ozpIwc.transport</a></li>
                                <li><a href="../modules/ozpIwc.transport.consensus.html">ozpIwc.transport.consensus</a></li>
                                <li><a href="../modules/ozpIwc.transport.listener.html">ozpIwc.transport.listener</a></li>
                                <li><a href="../modules/ozpIwc.transport.participant.html">ozpIwc.transport.participant</a></li>
                                <li><a href="../modules/ozpIwc.util.html">ozpIwc.util</a></li>
                                <li><a href="../modules/ozpIwc.worker.html">ozpIwc.worker</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src\js\bus\api\services\intents\api.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var ozpIwc = ozpIwc || {};
ozpIwc.api = ozpIwc.api || {};
ozpIwc.api.intents = ozpIwc.api.intents || {};

/**
 * @module ozpIwc.api
 * @submodule ozpIwc.api.intents
 */


ozpIwc.api.intents.Api = (function (api, log, ozpConfig, util) {
    /**
     * The Intents Api.
     * Subclasses the {{#crossLink &quot;ozpIwc.api.base.Api&quot;}}{{/crossLink}}.
     *
     * @class Api
     * @namespace ozpIwc.api.intents
     * @extends ozpIwc.api.base.Api
     * @constructor
     * @param {Object} config
     * @param {String} [config.name=&quot;intents.api&quot;]
     * @param {ozpIwc.transport.Router} config.router
     */
    var Api = api.createApi(&quot;intents.api&quot;, function (config) {
        this.endpoints = config.endpoints || [{link: ozpConfig.linkRelPrefix + &quot;:intent&quot;, headers: []}];
        this.contentTypeMappings = util.genContentTypeMappings(api.intents.node);
    });

//--------------------------------------------------
// API state initialization methods
//--------------------------------------------------
    Api.prototype.initializeData = function (deathScream) {
        deathScream = deathScream || {watchers: {}, collectors: [], data: []};
        this.watchers = deathScream.watchers;
        this.collectors = deathScream.collectors;
        deathScream.data.forEach(function (packet) {
            if (packet.resource.indexOf(&quot;/inFlightIntent&quot;) === 0) {
                packet.entity = packet.entity || {};
                packet.entity.dState = packet.entity.state;
                packet.entity.state = &quot;deserialize&quot;;
                this.createNode({
                    resource: packet.resource, invokePacket: {},
                    handlerChoices: [0, 1],
                    state: &quot;deserialize&quot;
                }, api.intents.InFlightNode).deserializeLive(packet);
            } else {
                this.createNode({resource: packet.resource}).deserializeLive(packet);
            }
        }, this);

        this.updateCollections();
        if (this.endpoints) {
            var self = this;
            var onResource = function (resource) {
                self.loadedResourceHandler(resource);
            };
            return Promise.all(this.endpoints.map(function (u) {
                return util.halLoader.load(u.link, u.headers, onResource).catch(function (err) {
                    log.error(self.logPrefix, &quot;load from endpoint failed. Reason: &quot;, err);
                });
            }));
        } else {
            return Promise.resolve();
        }
    };

//--------------------------------------------------
// Node creation/modification methods
//--------------------------------------------------
    /**
     * Maps a content-type to an IWC Node type. Overriden in APIs.
     * @method findNodeType
     * @param {Object} contentTypeObj an object-formatted content-type
     * @param {String} contentTypeObj.name the content-type without any variables
     * @param {Number} [contentTypeObj.version] the version of the content-type.
     * @returns {undefined}
     */
    Api.prototype.findNodeType = function (contentType) {
        var formattedContentType = util.getFormattedContentType(contentType);
        var type = this.contentTypeMappings[formattedContentType.name];
        if (type) {
            if (formattedContentType.version) {
                return type[formattedContentType.version];
            } else {
                return type;
            }
        }
    };


//---------------------------------------------------------
// Intent Invocation Methods
//---------------------------------------------------------
    /**
     * Notifies the invoker when the state of the in flight intent changes.
     * @method updateInvoker
     * @static
     * @private
     * @param {ozpIwc.api.intents.Api} api
     * @param node
     */
    var updateInvoker = function (api, node) {
        var response = node.entity.reply || {};
        return api.send({
            dst: node.entity.invokePacket.src,
            replyTo: node.entity.invokePacket.msgId,
            response: &quot;update&quot;,
            entity: {
                request: node.entity.entity,
                response: response.entity,
                handler: node.entity.handler,
                state: node.entity.state,
                status: node.entity.status
            }
        });
    };

    /**
     * A handler for invoke calls. Creates an inFlight-intent node and kicks off the inflight state machine.
     *
     * @method invokeIntentHandler
     * @param {Object} packet
     * @param {String} type
     * @param {String} action
     * @param {Object[]} handlers
     * @param {String} pattern
     * @return {Promise}
     */
    Api.prototype.invokeIntentHandler = function (packet, type, action, handlers, pattern) {
        var inflightNode = new api.intents.node.InFlightNode({
            resource: this.createKey(&quot;/inFlightIntent/&quot;),
            src: packet.src,
            invokePacket: packet,
            type: type,
            action: action,
            handlerChoices: handlers,
            pattern: pattern
        });

        this.data[inflightNode.resource] = inflightNode;
        this.addCollector(inflightNode);
        updateInvoker(this, inflightNode);
        this.data[inflightNode.resource] = api.intents.FSM.transition(inflightNode);
        return this.handleInflightIntentState(inflightNode);
    };

    /**
     * Handles the current state of the state machine.
     * If &quot;choosing&quot;, the intent chooser will open.
     * If &quot;delivering&quot;, the api will send the intent to the chosen handler
     * If &quot;complete&quot;, the api will send the intent handler&#x27;s reply back to the invoker and mark the inflight intent as
     * deleted.
     * @param {Object} inflightNode
     * @return {*}
     */
    Api.prototype.handleInflightIntentState = function (inflightNode) {
        switch (inflightNode.entity.state) {
            case &quot;choosing&quot;:
                return this.handleChoosing(inflightNode);
            case &quot;delivering&quot;:
                this.handleDelivering(inflightNode);
                break;
            case &quot;complete&quot;:
                this.handleComplete(inflightNode);
                break;
            case &quot;error&quot;:
                this.handleError(inflightNode);
                break;
            default:
                updateInvoker(this, inflightNode);
                break;
        }
        return Promise.resolve(inflightNode);
    };

    /**
     * A handler for the &quot;choosing&quot; state of an in-flight intent node.
     * @method handleChoosing
     * @param node
     * @return {Promise} Resolves when either a preference is gathered or the intent chooser is opened.
     */
    Api.prototype.handleChoosing = function (node) {
        var self = this;

        var useRegisteredChooser = function (intentNode) {

            var tryChooser = function (chooser) {
                var packet = util.clone(chooser.entity.invokeIntent);
                packet.entity = packet.entity || {};
                packet.src = packet.src || packet.dst;
                packet.replyTo = chooser.entity.replyTo;
                packet.entity.inFlightIntent = intentNode.toPacket();
                packet.entity.force = (util.getInternetExplorerVersion() === 11);
                if (util.runningInWorker) {
                    packet.entity.config = ozpConfig;
                    packet.entity.config.intentSelection = &quot;intents.api&quot; + node.resource;
                }

                return self.invokeIntentHandler(packet, &#x27;/inFlightIntent/chooser&#x27;, &#x27;choose&#x27;, [chooser], &#x27;/inFlightIntent/chooser/choose/&#x27;).then(function (inFlightNode) {
                    //This is because we are manually using the packetRouter route.
                    inFlightNode.entity = inFlightNode.entity || {};

                    if (inFlightNode.entity.state === &quot;complete&quot;) {
                        return true;
                    } else if (inFlightNode.entity.state === &quot;error&quot;) {
                        throw &quot;err&quot;;
                    } else {
                        var res, rej;
                        var promise = new Promise(function (resolve, reject) {
                            res = resolve;
                            rej = reject;
                        });
                        var onComplete = function (node) {
                            if (node.resource === inFlightNode.resource) {
                                api.intents.FSM.off(&quot;complete&quot;, onComplete);
                                res(true);
                            }
                        };
                        var onError = function (node) {
                            if (node.resource === inFlightNode.resource) {
                                api.intents.FSM.off(&quot;error&quot;, onError);
                                rej(&quot;err&quot;);
                            }
                        };
                        api.intents.FSM.on(&quot;complete&quot;, onComplete);
                        api.intents.FSM.on(&quot;error&quot;, onError);
                        return promise;
                    }
                });
            };

            var itterChoosers = function (choosers) {
                if (choosers.length &gt; 0) {
                    return tryChooser(choosers[0]).then(function () {
                        return Promise.resolve();
                    }).catch(function (err) {
                        choosers.shift();
                        return itterChoosers(choosers);
                    });
                } else {
                    return Promise.reject(&quot;no choosers.&quot;);
                }
            };

            var invokersChooser = self.matchingNodes(&#x27;/inFlightIntent/chooser/choose/&#x27; + intentNode.entity.invokePacket.src);
            var registeredChoosers = self.matchingNodes(&#x27;/inFlightIntent/chooser/choose/&#x27;);

            return itterChoosers(invokersChooser).catch(function(err) {
                return itterChoosers(registeredChoosers);
            });
        };

        var showChooser = function (err) {
            log.info(&quot;Picking chooser because&quot;, err);
            return useRegisteredChooser(node).catch(function (err) {

                if (util.getInternetExplorerVersion() !== 11) {
                    log.info(&quot;launching popup chooser because: &quot;, err);
                    if (!util.runningInWorker) {
                        util.openWindow(ozpConfig.intentsChooserUri, {
                            &quot;ozpIwc.peer&quot;: ozpConfig._busRoot,
                            &quot;ozpIwc.intentSelection&quot;: &quot;intents.api&quot; + node.resource
                        }, ozpConfig.intentChooserFeatures);
                    }
                } else {
                    log.error(&quot;Failed to handle intent choosing: Internet Explorer 11 is not supported&quot; +
                        &quot; for the default intent chooser.&quot;);
                    node = api.intents.FSM.transition(node, {state: &quot;error&quot;});
                }

                return node;
            });
        };

        updateInvoker(this, node);
        return this.getPreference(node.entity.invokePacket.src + &quot;/&quot; + node.entity.intent.type + &quot;/&quot; + node.entity.intent.action).then(function (handlerResource) {
            if (handlerResource in self.data) {
                node = api.intents.FSM.transition(node, {
                    entity: {
                        state: &quot;delivering&quot;,
                        &#x27;handler&#x27;: {
                            &#x27;resource&#x27;: handlerResource,
                            &#x27;reason&#x27;: &quot;remembered&quot;
                        }
                    }
                });
                updateInvoker(self, node);
                return self.handleInflightIntentState(node);
            } else {
                return showChooser();
            }
        }).catch(showChooser);
    };

    /**
     *  A handler for the &quot;delivering&quot; state of an in-flight intent node.
     *  Sends a packet to the chosen handler.
     *
     *  @TODO should resolve on response from the handler that transitions the node to &quot;running&quot;.
     *
     * @method handleDelivering
     * @param {ozpIwc.api.base.Node} node
     */
    Api.prototype.handleDelivering = function (node) {
        var handlerNode = this.data[node.entity.handler.resource];

        var packet = util.clone(handlerNode.entity.invokeIntent);
        packet.entity = packet.entity || {};
        packet.replyTo = handlerNode.entity.replyTo;
        packet.entity.inFlightIntent = node.toPacket();
        log.debug(this.logPrefix + &quot;delivering intent:&quot;, packet);
        updateInvoker(this, node);
        // TODO: packet permissions
        return this.send(packet);
    };

    /**
     * A handler for the &quot;complete&quot; state of an in-flight intent node.
     * Sends notification to the invoker that the intent was handled &amp; deletes the in-flight intent node as it is no
     * longer needed.
     *
     * @method handleComplete
     * @param {ozpIwc.api.base.Node} node
     */
    Api.prototype.handleComplete = function (node) {
        if (node.entity.invokePacket &amp;&amp; node.entity.invokePacket.src &amp;&amp; node.entity.reply) {
            this.send({
                dst: node.entity.invokePacket.src,
                replyTo: node.entity.invokePacket.msgId,
                contentType: node.entity.reply.contentType,
                response: &quot;complete&quot;,
                resource: node.entity.handler.resource,
                entity: node.entity.reply.entity
            });
            updateInvoker(this, node);
        }
        node.markAsDeleted();
    };
    /**
     * A handler for the &quot;error&quot; state of an in-flight intent node.
     * Sends notification to the invoker that the intent was handled &amp; deletes the in-flight intent node as it is no
     * longer needed.
     *
     * @method handleError
     * @param {ozpIwc.api.base.Node} node
     */
    Api.prototype.handleError = function (node) {
        if (node.entity.invokePacket &amp;&amp; node.entity.invokePacket.src) {
            this.send({
                dst: node.entity.invokePacket.src,
                replyTo: node.entity.invokePacket.msgId,
                contentType: node.entity.reply.contentType,
                response: &quot;noResult&quot;,
                resource: node.entity.handler.resource,
                entity: node.entity.reply.entity
            });
            updateInvoker(this, node);
        }
        node.markAsDeleted();
    };

    return Api;

}(ozpIwc.api, ozpIwc.log, ozpIwc.config, ozpIwc.util));

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
